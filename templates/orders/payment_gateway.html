{% extends "base.html" %}
{% load static %}

{% block title %}Secure Payment - CertiBuy{% endblock %}

{% block content %}
<section style="padding-top: 5rem; padding-bottom: 3rem; background: #f8f9fa; min-height: 100vh;">
    <div class="container" style="max-width: 600px;">
        <div style="background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 3rem;">
            <h1 style="font-size: 1.75rem; font-weight: 700; color: #1e293b; margin-bottom: 1rem; text-align: center;">
                <i class="fas fa-lock"></i> Secure Payment
            </h1>
            <p style="text-align: center; color: #64748b; margin-bottom: 2rem;">Your payment is encrypted and secure. Powered by Razorpay.</p>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                    <span style="color: #64748b;">Order Number</span>
                    <strong style="color: #1e293b;">{{ order.order_number }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                    <span style="color: #64748b;">Amount</span>
                    <strong style="color: #1e293b; font-size: 1.2rem;">â‚¹{{ order.total_amount|floatformat:2 }}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: #64748b;">Payment Method</span>
                    <strong style="color: #1e293b;">{{ order.get_payment_method_display }}</strong>
                </div>
            </div>

            <button id="pay-button" 
                data-razorpay-key="{{ razorpay_key }}"
                data-order-id="{{ order.razorpay_order_id }}"
                data-order-number="{{ order.order_number }}"
                data-user-name="{{ request.user.first_name }} {{ request.user.last_name }}"
                data-user-email="{{ request.user.email }}"
                data-user-phone="{{ order.address.phone }}"
                data-amount="{{ amount_paise }}"
                style="width: 100%; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 1rem; border: none; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; margin-bottom: 1rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(37, 99, 235, 0.3)'">
                <i class="fas fa-credit-card"></i> Complete Payment
            </button>
            
            <a href="{% url 'orders:order_tracking' order.id %}" style="display: block; text-align: center; padding: 1rem; border: 1px solid #cbd5e1; border-radius: 8px; color: #475569; text-decoration: none; font-weight: 600;">View Order</a>

            <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border: 1px solid #bbf7d0; margin-top: 2rem;">
                <h4 style="color: #166534; margin-top: 0; margin-bottom: 0.75rem;"><i class="fas fa-shield-alt"></i> Payment Security</h4>
                <ul style="list-style: none; padding: 0; margin: 0; color: #166534;">
                    <li style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle"></i> 256-bit SSL Encryption</li>
                    <li style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle"></i> PCI DSS Compliant</li>
                    <li><i class="fas fa-check-circle"></i> 3D Secure Authentication</li>
                </ul>
            </div>
        </div>
    </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
// PRODUCTION-READY RAZORPAY INTEGRATION
// Security Features: Official Hosted Checkout, CSRF validation, Amount verification, Proper error handling

document.getElementById('pay-button').addEventListener('click', function(e) {
    e.preventDefault();
    
    const button = this;
    const originalHTML = button.innerHTML;
    
    // Get data from button attributes
    const key = button.dataset.razorpayKey;
    const orderId = button.dataset.orderId;
    const orderNumber = button.dataset.orderNumber;
    const userName = button.dataset.userName;
    const userEmail = button.dataset.userEmail;
    const userPhone = button.dataset.userPhone;
    const amount = parseInt(button.dataset.amount);
    
    // Validate prerequisites
    if (!key || key.trim() === '' || key.includes('undefined')) {
        console.error('[SECURITY] Razorpay key not configured');
        alert('Payment gateway is not properly configured. Please contact support.');
        return;
    }
    
    // Validate key format (should be rzp_test_* or rzp_live_*)
    if (!key.match(/^rzp_(test|live)_/)) {
        console.error('[SECURITY] Invalid Razorpay key format');
        alert('Payment gateway configuration error. Please contact support.');
        return;
    }
    
    // Validate amount
    if (!amount || amount <= 0) {
        console.error('[SECURITY] Invalid amount:', amount);
        alert('Invalid order amount. Please contact support.');
        return;
    }
    
    // Validate order ID
    if (!orderId || orderId.length < 15) {
        console.error('[SECURITY] Invalid order ID');
        alert('Invalid order ID. Please contact support.');
        return;
    }
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opening secure payment portal...';
    
    // RAZORPAY OFFICIAL CHECKOUT OPTIONS
    const options = {
        key: key,
        amount: amount,
        currency: "INR",
        order_id: orderId,
        name: "CertiBuy",
        description: "Order " + orderNumber + " - Certified Products Marketplace",
        
        // Accepted payment methods
        method: {
            emandate: false,
            recurring: false
        },
        
        // Prefill customer data
        prefill: {
            name: userName || 'Customer',
            email: userEmail || '',
            contact: userPhone || ''
        },
        
        // Payment success handler
        handler: function(response) {
            console.log('[PAYMENT] Payment successful:', {
                payment_id: response.razorpay_payment_id,
                order_id: response.razorpay_order_id
            });
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying payment...';
            
            // CSRF token validation
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                console.error('[SECURITY] CSRF token not found');
                alert('Security error: CSRF token missing. Please refresh and try again.');
                button.disabled = false;
                button.innerHTML = originalHTML;
                return;
            }
            
            // SERVER-SIDE VERIFICATION
            fetch('{% url "orders:payment_callback" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken.value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    'razorpay_payment_id': response.razorpay_payment_id,
                    'razorpay_order_id': response.razorpay_order_id,
                    'razorpay_signature': response.razorpay_signature
                })
            })
            .then(res => {
                console.log('[PAYMENT] Callback response status:', res.status);
                if (!res.ok) throw new Error('HTTP ' + res.status + ': Payment verification failed');
                return res.json();
            })
            .then(data => {
                console.log('[PAYMENT] Verification result:', data.status);
                if (data.status === 'success') {
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Payment Successful!';
                    console.log('[PAYMENT] Redirecting to confirmation...');
                    setTimeout(() => {
                        window.location.href = '{% url "orders:order_confirmation" 0 %}'.replace('0', data.order_id);
                    }, 1000);
                } else {
                    throw new Error(data.message || 'Payment verification failed');
                }
            })
            .catch(err => {
                console.error('[PAYMENT_ERROR] Verification error:', err.message);
                alert('Payment verification failed: ' + err.message + '\n\nOrder number: ' + orderNumber + '\n\nPlease contact support if amount was deducted.');
                button.disabled = false;
                button.innerHTML = originalHTML;
            });
        },
        
        theme: {
            color: "#2563eb"
        },
        
        // Modal configuration
        modal: {
            ondismiss: function() {
                console.log('[PAYMENT] User dismissed payment popup');
                button.disabled = false;
                button.innerHTML = originalHTML;
            },
            onopen: function() {
                console.log('[PAYMENT] Razorpay popup opened');
                button.innerHTML = '<i class="fas fa-lock"></i> Secure Payment in Progress...';
            }
        }
    };
    
    // Initialize and open Razorpay checkout
    try {
        console.log('[PAYMENT] Initializing Razorpay with order ID:', orderId);
        const razorpay = new Razorpay(options);
        
        // Handle payment failure from Razorpay
        razorpay.on('payment.failed', function(response) {
            console.error('[PAYMENT_FAILED]', response.error);
            alert('Payment failed: ' + response.error.description + '\n\nReason: ' + response.error.reason + '\n\nPlease try again or use another payment method.');
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
        
        // Open the secure Razorpay checkout popup
        console.log('[PAYMENT] Opening Razorpay secure checkout');
        razorpay.open();
    } catch (error) {
        console.error('[PAYMENT_ERROR] Failed to open Razorpay:', error);
        alert('Error opening payment gateway: ' + error.message + '\n\nPlease try again.');
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
});
</script>
{% endblock %}
